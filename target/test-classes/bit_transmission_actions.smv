AGENT main
--VAR
--    state: {snd, rec, SR, none};
ACTION : {snd, rec, SR, none};

INVISIBLEVAR
    s : Sender;
    r : Receiver;

--PROTOCOL
--  TRUE: {snd, rec, SR, none};
--END

--ASSIGN
--    next(state) := case
--                ACT=snd : snd;
--                ACT=rec : rec;
--                ACT=SR : SR;
--                ACT=none : none;
--    esac;

--JUSTICE ACT=SR;


AGENT Sender
VAR
    bit : {0,1};
    ack : boolean;

ACTION : {sb0,sb1,none};

INIT !ack;

--Sender's protocol
PROTOCOL
	(bit=0 & !ack) : sb0;
	(bit=1 & !ack) : sb1;
	ack : none;
END

--Sender's evolution function
ASSIGN
next(ack) := case
   (!ack & r.ACT=sendack & (main.ACT=SR | main.ACT=rec)) : TRUE;
   1 : ack;   
esac;


AGENT Receiver
VAR
   state : {empty, r0, r1};

ACTION : {none, sendack};

INIT state=empty;

--Receiver's protocol
PROTOCOL 
	(state=empty) : none;
	(state=r0 | state=r1) : sendack;
END

--Receiver's evolution function
ASSIGN
next(state) := case
   (s.ACT=sb0 & state=empty & (main.ACT=SR | main.ACT=snd)) : r0;
   (s.ACT=sb1 & state=empty & (main.ACT=SR | main.ACT=snd)) : r1;
   1 : state;
esac;


